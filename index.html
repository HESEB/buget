<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Captcha Bugs (MVP)</title>
<style>
:root {
  --ui: rgba(255,255,255,.86);
  --ui2: rgba(255,255,255,.72);
  --shadow: rgba(0,0,0,.35);
  --grad: linear-gradient(90deg,#F185AE,#F8B871,#A573ED,#6BB2FF);
  --bg: #0b1220;
  --accent: #5b9dff;
  --danger: #ff4a7e;
  --ok: #46c6a5;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{margin:0;height:100%;background:var(--bg);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;}
#app{height:100%;width:100%;overflow:hidden;position:relative;}
/* screens */
.screen{position:absolute;inset:0;display:none;}
.screen.active{display:block;}
/* Title */
#titleScreen{background:#000;}
#titleBg{position:absolute;inset:0;background: url('assets/title.png') center/cover no-repeat; filter:saturate(1.05) contrast(1.05);}
#titleVignette{position:absolute;inset:0;background: radial-gradient(ellipse at center, rgba(0,0,0,.15), rgba(0,0,0,.75));}
#titleUI{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;padding:18px 16px 22px;gap:12px;}
.btn{border:none;border-radius:18px;padding:14px 16px;font-weight:800;font-size:16px;letter-spacing:.2px;cursor:pointer;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.35);}
.btn.primary{background:var(--grad);color:#121624;}
.btn.ghost{background:rgba(255,255,255,.16);color:rgba(255,255,255,.92);border:1px solid rgba(255,255,255,.22);}
.small{font-size:12px;color:rgba(255,255,255,.78);line-height:1.4;max-width:420px;text-align:center;}
/* Field */
#fieldScreen{background:#000;}
#hudTop{position:absolute;left:10px;right:10px;top:10px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;z-index:30;pointer-events:none;}
.hudCard{pointer-events:auto;background:var(--ui);border-radius:16px;padding:10px 12px;box-shadow:0 10px 26px rgba(0,0,0,.25);backdrop-filter: blur(8px);}
#playerBadge{display:flex;align-items:center;gap:10px;cursor:pointer;}
#playerBadge .meta{display:flex;flex-direction:column;line-height:1.15;}
#playerName{font-weight:900;font-size:14px;color:#161a22;}
#playerTitle{font-weight:800;font-size:12px;color:rgba(22,26,34,.68);}
#pointsBox{display:flex;align-items:center;gap:8px;}
#pointsBox .num{font-weight:1000;font-size:14px;color:#161a22;}
.pill{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.06);font-weight:900;font-size:12px;color:rgba(22,26,34,.75);}
/* Bottom bar */
#hudBottom{position:absolute;left:0;right:0;bottom:0;padding:10px 10px 14px;z-index:30;}
#bottomBar{display:flex;gap:10px;justify-content:center;align-items:center;}
.iconBtn{border:none;border-radius:18px;padding:12px 14px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.92);font-weight:900;min-width:110px;box-shadow:0 14px 26px rgba(0,0,0,.22);}
.iconBtn strong{display:block;font-size:13px;}
.iconBtn span{display:block;font-size:11px;opacity:.85;font-weight:800;}
/* World */
#view{position:absolute;inset:0;overflow:hidden;}
#worldWrap{position:absolute;inset:-18% -18% -10% -18%;}
#world{position:absolute;inset:0;transform-origin:50% 70%;transform: perspective(900px) rotateX(30deg) scale(1.05);}
.layer{position:absolute;inset:-20%;background-repeat:repeat;will-change:transform;}
/* simple procedural layers using gradients + noise-like patterns */
#layerSky{background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), rgba(255,255,255,.0) 45%),
                 linear-gradient(#79b7ff,#bfe7ff 55%, #b7f0ff); filter:saturate(1.05); opacity:.95;}
#layerMid{background:
  radial-gradient(circle at 20% 60%, rgba(25,70,35,.95), rgba(25,70,35,0) 55%),
  radial-gradient(circle at 70% 55%, rgba(20,60,30,.95), rgba(20,60,30,0) 60%),
  radial-gradient(circle at 40% 40%, rgba(35,90,45,.9), rgba(35,90,45,0) 55%),
  linear-gradient(#2f7a3f,#2f7a3f);
  filter: blur(.4px) saturate(1.05) contrast(1.02);
  opacity:.95;
}
#layerFore{background:
  radial-gradient(circle at 15% 90%, rgba(30,140,70,.95), rgba(30,140,70,0) 40%),
  radial-gradient(circle at 45% 100%, rgba(40,170,80,.95), rgba(40,170,80,0) 45%),
  radial-gradient(circle at 75% 95%, rgba(35,155,78,.95), rgba(35,155,78,0) 40%),
  linear-gradient(#2aa45e,#1f7d46);
  filter:saturate(1.06);
  opacity:.98;
}
#groundMist{position:absolute;inset:0;background: radial-gradient(ellipse at 50% 70%, rgba(255,255,255,.10), rgba(0,0,0,.0) 55%), linear-gradient(to top, rgba(0,0,0,.25), rgba(0,0,0,0) 30%); pointer-events:none;}
/* Player */
#player{position:absolute;left:50%;bottom:64px;transform:translateX(-50%);width:min(240px,55vw);z-index:20;filter: drop-shadow(0 18px 18px rgba(0,0,0,.35));pointer-events:none;opacity:.98;}
#player img{width:100%;height:auto;display:block;}
/* Entities */
#entities{position:absolute;inset:0;z-index:25;}
.entity{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);transform-origin:50% 70%;cursor:pointer;}
.entity .sprite{width:56px;height:56px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-weight:1000;color:#111;box-shadow:0 12px 20px rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.45);}
.entity.bug .sprite{background: rgba(255,255,255,.90);}
.entity.treasure .sprite{background: rgba(255,255,255,.92);}
.entity .label{margin-top:6px;text-align:center;font-size:11px;font-weight:900;color:rgba(255,255,255,.95);text-shadow:0 2px 10px rgba(0,0,0,.55);}
.entity.locked{opacity:.55;pointer-events:none;}
.entity .hint{position:absolute;left:50%;top:-12px;transform:translateX(-50%);padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.45);color:#fff;font-size:10px;font-weight:900;white-space:nowrap;}
/* Overlays & Modals */
.overlay{position:absolute;inset:0;background:rgba(8,10,15,.65);backdrop-filter: blur(8px);display:none;z-index:60;}
.overlay.active{display:block;}
.modal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(94vw,520px);max-height:min(84vh,720px);overflow:auto;background:rgba(255,255,255,.92);border-radius:22px;box-shadow:0 24px 60px rgba(0,0,0,.35);padding:14px 14px 16px;}
.modal h2{margin:6px 6px 10px;font-size:16px;font-weight:1000;color:#141826;}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.kv{flex:1;min-width:160px;background:rgba(0,0,0,.06);border-radius:16px;padding:10px 12px;}
.kv .k{font-size:11px;font-weight:1000;color:rgba(0,0,0,.55);}
.kv .v{font-size:14px;font-weight:1000;color:#141826;margin-top:4px;}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;}
.mbtn{border:none;border-radius:16px;padding:10px 12px;font-weight:1000;cursor:pointer;}
.mbtn.primary{background:var(--grad);color:#151a22;}
.mbtn.secondary{background:rgba(0,0,0,.08);}
/* Dex */
#dexGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:6px;}
.card{background:rgba(255,255,255,.90);border-radius:18px;padding:10px;box-shadow:0 14px 30px rgba(0,0,0,.15);border:1px solid rgba(0,0,0,.06);cursor:pointer;}
.card .top{display:flex;gap:10px;align-items:center;}
.card .icon{width:46px;height:46px;border-radius:16px;background:rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;font-size:22px;}
.card .t1{font-weight:1000;font-size:13px;color:#141826;}
.card .t2{font-weight:900;font-size:11px;color:rgba(20,24,38,.65);margin-top:2px;}
.card .meta{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}
.badge{font-size:10px;font-weight:1000;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,.06);color:rgba(20,24,38,.75);}
.badge.r{background:rgba(91,157,255,.18);}
.badge.p{background:rgba(255,74,126,.14);}
.badge.g{background:rgba(70,198,165,.18);}
.card .count{margin-top:10px;font-size:11px;font-weight:1000;color:rgba(20,24,38,.75);}
/* Encounter */
#encounterOverlay{z-index:80;}
#encounterStage{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;padding:18px 14px 18px;}
#encounterCard{width:min(94vw,520px);background:rgba(255,255,255,.94);border-radius:26px;box-shadow:0 28px 70px rgba(0,0,0,.45);overflow:hidden;}
#encounterTop{position:relative;height:220px;background:
  radial-gradient(circle at 30% 30%, rgba(255,255,255,.8), rgba(255,255,255,0) 55%),
  linear-gradient(180deg, rgba(120,210,255,.7), rgba(55,160,110,.65));
}
#encounterBug{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);text-align:center;}
#encounterBug .big{font-size:74px;filter: drop-shadow(0 14px 20px rgba(0,0,0,.25));}
#encounterBug .name{margin-top:6px;font-weight:1000;color:#121624;}
#encounterBug .id{font-size:12px;font-weight:900;color:rgba(18,22,36,.65);}
#netAnim{position:absolute;right:-20px;bottom:-40px;width:260px;transform:rotate(-18deg);opacity:.95;filter: drop-shadow(0 18px 22px rgba(0,0,0,.25));}
#netAnim.swing{animation:swing .55s ease-in-out 1;}
@keyframes swing{
  0%{transform:translate(0,0) rotate(-18deg) scale(1);}
  35%{transform:translate(-46px,-26px) rotate(-42deg) scale(1.04);}
  70%{transform:translate(-18px,-6px) rotate(-22deg) scale(1.01);}
  100%{transform:translate(0,0) rotate(-18deg) scale(1);}
}
#encounterBody{padding:12px 14px 14px;}
#encounterInfo{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;}
#encounterInfo .left{display:flex;gap:8px;flex-wrap:wrap;}
#encounterInfo .right{font-weight:1000;color:rgba(20,24,38,.75);}
#encounterActions{display:flex;gap:10px;margin-top:12px;}
#encounterActions .mbtn{flex:1;border-radius:18px;padding:12px 12px;}
#resultLine{margin-top:10px;font-weight:1000;font-size:14px;}
#resultLine.ok{color:#0e6b52;}
#resultLine.no{color:#b12b4b;}
/* toast */
#toast{position:absolute;left:50%;bottom:92px;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:10px 12px;border-radius:999px;font-weight:900;font-size:12px;display:none;z-index:90;}
/* responsive */
@media (min-width:860px){
  #app{max-width:420px;margin:0 auto;box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 32px 80px rgba(0,0,0,.55);}
  body{background: radial-gradient(ellipse at top, rgba(91,157,255,.10), rgba(0,0,0,0)), #070b16;}
}
</style>
</head>
<body>
<div id="app">
  <!-- TITLE -->
  <div id="titleScreen" class="screen active">
    <div id="titleBg"></div>
    <div id="titleVignette"></div>
    <div id="titleUI">
      <button id="startBtn" class="btn primary">ì‹œì‘í•˜ê¸°</button>
      <button id="quickDexBtn" class="btn ghost">ë„ê° ë³´ê¸°</button>
      <div class="small">MVP í…ŒìŠ¤íŠ¸ ë¹Œë“œ Â· ì˜¤í”„ë¼ì¸ ì €ì¥(LocalStorage) Â· ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ êµì²´í˜• êµ¬ì¡°</div>
    </div>
  </div>

  <!-- FIELD -->
  <div id="fieldScreen" class="screen">
    <div id="view">
      <div id="worldWrap">
        <div id="world">
          <div id="layerSky" class="layer"></div>
          <div id="layerMid" class="layer"></div>
          <div id="layerFore" class="layer"></div>
          <div id="groundMist"></div>
        </div>
      </div>
      <div id="entities"></div>
      <div id="player"><img src="assets/player.png" alt="player"/></div>
    </div>

    <div id="hudTop">
      <div id="playerBadge" class="hudCard" title="í”„ë¡œí•„ ë³´ê¸°">
        <div class="meta">
          <div id="playerName">ì€ì„±ì´</div>
          <div id="playerTitle">ì´ˆë³´ íƒí—˜ê°€</div>
        </div>
        <div class="pill" id="envPill">FOREST</div>
      </div>
      <div id="pointsBox" class="hudCard">
        <div class="pill">POINT</div>
        <div class="num" id="pointsNum">0</div>
      </div>
    </div>

    <div id="hudBottom">
      <div id="bottomBar">
        <button id="dexBtn" class="iconBtn"><strong>ë„ê°</strong><span>ì „ì²´ í™”ë©´</span></button>
        <button id="bagBtn" class="iconBtn"><strong>ê°€ë°©</strong><span>ì•„ì´í…œ</span></button>
        <button id="settingsBtn" class="iconBtn"><strong>ì„¤ì •</strong><span>í…ŒìŠ¤íŠ¸</span></button>
      </div>
    </div>
    <div id="toast"></div>
  </div>

  <!-- MODAL OVERLAY -->
  <div id="overlay" class="overlay">
    <div id="modal" class="modal"></div>
  </div>

  <!-- ENCOUNTER -->
  <div id="encounterOverlay" class="overlay">
    <div id="encounterStage">
      <div id="encounterCard">
        <div id="encounterTop">
          <img id="netAnim" src="assets/net.png" alt="net"/>
          <div id="encounterBug">
            <div class="big" id="encBugEmoji">ğŸ</div>
            <div class="name" id="encBugName">ë¬´ë‹¹ë²Œë ˆ</div>
            <div class="id" id="encBugId">LE-000</div>
          </div>
        </div>
        <div id="encounterBody">
          <div id="encounterInfo">
            <div class="left">
              <span class="badge r" id="encRarity">COMMON</span>
              <span class="badge" id="encRegion">FOREST</span>
              <span class="badge" id="encTime">DAY</span>
              <span class="badge" id="encWeather">SUNNY</span>
            </div>
            <div class="right" id="encHint">ê°€ê¹Œì´ì—ì„œ ë§ˆì£¼ì³¤ë‹¤</div>
          </div>
          <div id="encounterActions">
            <button id="useBaitBtn" class="mbtn secondary">ë¨¹ì´ ì‚¬ìš©(+ì„±ê³µ)</button>
            <button id="catchBtn" class="mbtn primary">ì±„ì§‘!</button>
            <button id="closeEncBtn" class="mbtn secondary">ë‹«ê¸°</button>
          </div>
          <div id="resultLine"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const INSECTS = [{"name": "í†±ì‚¬ìŠ´ë²Œë ˆ", "key": "saw_stag_beetle", "id": "BE-001", "rarity": "UNCOMMON", "regions": ["FOREST"], "times": ["NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["í†±ë‹ˆ ëª¨ì–‘ì˜ í° í„±ì´ íŠ¹ì§•ì´ë‹¤.", "ìˆ˜ì»·ì€ í„±ìœ¼ë¡œ ê²½ìŸí•œë‹¤.", "ì•¼í–‰ì„± ê³¤ì¶©ì´ë‹¤."]}, {"name": "ì• ì‚¬ìŠ´ë²Œë ˆ", "key": "small_stag_beetle", "id": "BE-002", "rarity": "COMMON", "regions": ["FOREST"], "times": ["NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì‘ì€ ì²´í˜•ì˜ ì‚¬ìŠ´ë²Œë ˆë‹¤.", "ì˜¨ìˆœí•œ ì„±ê²©ì´ë‹¤.", "ê´€ì°°ì´ ë¹„êµì  ì‰½ë‹¤."]}, {"name": "ë„™ì ì‚¬ìŠ´ë²Œë ˆ", "key": "flat_stag_beetle", "id": "BE-003", "rarity": "UNCOMMON", "regions": ["FOREST"], "times": ["DAY", "EVENING"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ëª¸ì´ ë„“ê³  ë‚©ì‘í•˜ë‹¤.", "ì€ì‹ ì— ìœ ë¦¬í•˜ë‹¤.", "ì¡°ìš©íˆ í™œë™í•œë‹¤."]}, {"name": "ì¥ìˆ˜í’ë…ì´", "key": "j_rhinobeetle", "id": "BE-004", "rarity": "UNCOMMON", "regions": ["FOREST"], "times": ["NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ê°•í•œ í˜ì„ ê°€ì§„ ê³¤ì¶©ì´ë‹¤.", "ìˆ˜ì»·ì€ ë¿”ë¡œ ì‹¸ìš´ë‹¤.", "ìœ ì¶©ì€ ë•…ì†ì—ì„œ ìë€ë‹¤."]}, {"name": "ë¹„ë‹¨ë²Œë ˆ", "key": "jewel_beetle", "id": "BE-005", "rarity": "RARE", "regions": ["MOUNTAIN", "FOREST"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ê¸ˆì† ê´‘íƒì˜ ëª¸ì„ ê°€ì¡Œë‹¤.", "í¬ê·€í•œ ì¢…ì´ë‹¤.", "ë³´í˜¸ ê°€ì¹˜ê°€ ë†’ë‹¤."]}, {"name": "ì‡ ë˜¥êµ¬ë¦¬", "key": "dung_beetle", "id": "BE-006", "rarity": "COMMON", "regions": ["GRASSLAND", "FARM"], "times": ["DAY", "EVENING"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë°°ì„¤ë¬¼ì„ êµ´ë ¤ ì´ìš©í•œë‹¤.", "í† ì–‘ì„ ë¹„ì˜¥í•˜ê²Œ ë§Œë“ ë‹¤.", "ìƒíƒœê³„ì— ì¤‘ìš”í•˜ë‹¤."]}, {"name": "í’€ìƒ‰ê½ƒë¬´ì§€", "key": "green_flower_beetle", "id": "BE-007", "rarity": "COMMON", "regions": ["PARK", "GRASSLAND"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì´ˆë¡ë¹› ê´‘íƒì´ ë‚œë‹¤.", "ë‚®ì— í™œë™í•œë‹¤.", "ê´€ì°°ì´ ì‰½ë‹¤."]}, {"name": "ì ë°•ì´ê½ƒë¬´ì§€", "key": "spotted_flower_beetle", "id": "BE-008", "rarity": "COMMON", "regions": ["PARK", "CITY"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì ë¬´ëŠ¬ê°€ íŠ¹ì§•ì´ë‹¤.", "í™œë™ì ì´ë‹¤.", "ë„ì‹¬ì—ì„œë„ ë³´ì¸ë‹¤."]}, {"name": "ê¸¸ì•ì¡ì´", "key": "tiger_beetle", "id": "BE-009", "rarity": "UNCOMMON", "regions": ["GRASSLAND", "PARK"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ë§¤ìš° ë¹ ë¥¸ ê³¤ì¶©ì´ë‹¤.", "í¬ì‹ì„±ì´ë‹¤.", "ì‚¬ëƒ¥ì— íŠ¹í™”ëë‹¤."]}, {"name": "ë¬¼ë°©ê°œ", "key": "diving_beetle", "id": "AQ-001", "rarity": "UNCOMMON", "regions": ["LAKE", "WETLAND"], "times": ["DAY", "EVENING"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì ìˆ˜ ìƒí™œì„ í•œë‹¤.", "ê³µê¸°ë¥¼ ì €ì¥í•œë‹¤.", "ë¬¼ì† í¬ì‹ìë‹¤."]}, {"name": "ì¥ìˆ˜í•˜ëŠ˜ì†Œ", "key": "longhorn_beetle", "id": "BE-010", "rarity": "RARE", "regions": ["FOREST", "MOUNTAIN"], "times": ["NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë”ë“¬ì´ê°€ ë§¤ìš° ê¸¸ë‹¤.", "í¬ê·€í•œ ì¢…ì´ë‹¤.", "ë‚˜ë¬´ì™€ ê¹Šì€ ê´€ë ¨ì´ ìˆë‹¤."]}, {"name": "ë²„ë“¤í•˜ëŠ˜ì†Œ", "key": "willow_longhorn", "id": "BE-011", "rarity": "UNCOMMON", "regions": ["RIVER", "WETLAND"], "times": ["DAY", "EVENING"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ê°€ëŠ˜ê³  ê¸´ ëª¸ì´ë‹¤.", "ë²„ë“œë‚˜ë¬´ì— ì„œì‹í•œë‹¤.", "ìœ ì¶©ì€ ëª©ì§ˆì„ ë¨¹ëŠ”ë‹¤."]}, {"name": "ë½•ë‚˜ë¬´í•˜ëŠ˜ì†Œ", "key": "mulberry_longhorn", "id": "BE-012", "rarity": "UNCOMMON", "regions": ["FARM", "PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë†ì—… í•´ì¶©ì´ë‹¤.", "í™œë™ë ¥ì´ ë›°ì–´ë‚˜ë‹¤.", "ê°œì²´ ìˆ˜ê°€ ë§ë‹¤."]}, {"name": "ì¤„í•˜ëŠ˜ì†Œ", "key": "striped_longhorn", "id": "BE-013", "rarity": "COMMON", "regions": ["FOREST", "PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì¤„ë¬´ëŠ¬ê°€ ëšœë ·í•˜ë‹¤.", "ë‚®ì—ë„ í™œë™í•œë‹¤.", "ê´€ì°°ì´ ì‰½ë‹¤."]}, {"name": "ê±°ìœ„ë²Œë ˆ", "key": "giraffe_weevil", "id": "BE-014", "rarity": "RARE", "regions": ["FOREST"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ëª©ì´ ê¸¸ë‹¤.", "ìì„ ë§ì•„ ì•Œì„ ë‚³ëŠ”ë‹¤.", "íŠ¹ì´í•œ ìƒê¹€ìƒˆë‹¤."]}, {"name": "ìë²Œë ˆ", "key": "leaf_beetle", "id": "BE-015", "rarity": "COMMON", "regions": ["GRASSLAND", "PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ìì„ ê°‰ì•„ë¨¹ëŠ”ë‹¤.", "ì¢…ë¥˜ê°€ ë§¤ìš° ë§ë‹¤.", "í•´ì¶©ìœ¼ë¡œ ë¶„ë¥˜ë˜ê¸°ë„ í•œë‹¤."]}, {"name": "ê²€ì€ë°ë…¸ë‘ë‚˜ë¹„", "key": "black_yellow_butterfly", "id": "LE-001", "rarity": "UNCOMMON", "regions": ["FOREST", "PARK"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ê°•í•œ ëŒ€ë¹„ ìƒ‰ì„ ê°€ì§„ë‹¤.", "í™œë™ì ì´ë‹¤.", "ë‚ ê°œ ë¬´ëŠ¬ê°€ ì„ ëª…í•˜ë‹¤."]}, {"name": "ë°°ì¶”í°ë‚˜ë¹„", "key": "cabbage_butterfly", "id": "LE-002", "rarity": "COMMON", "regions": ["FARM", "PARK", "CITY"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["í°ìƒ‰ ë‚ ê°œê°€ íŠ¹ì§•ì´ë‹¤.", "ì• ë²Œë ˆëŠ” í•´ì¶©ì´ë‹¤.", "ë„ì‹¬ì—ì„œë„ í”í•˜ë‹¤."]}, {"name": "í˜¸ë‘ë‚˜ë¹„", "key": "swallowtail_butterfly", "id": "LE-003", "rarity": "COMMON", "regions": ["GRASSLAND", "PARK"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ëŒ€í˜• ë‚˜ë¹„ë‹¤.", "ë¹„í–‰ì´ ìš°ì•„í•˜ë‹¤.", "ì™„ì „ë³€íƒœ ê³¤ì¶©ì´ë‹¤."]}, {"name": "ì²­ë ì‹ ì„ ë‚˜ë¹„", "key": "blue_band_butterfly", "id": "LE-004", "rarity": "RARE", "regions": ["FOREST"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["í‘¸ë¥¸ ë  ë¬´ëŠ¬ê°€ ìˆë‹¤.", "ìˆ² ê·¸ëŠ˜ì„ ì¢‹ì•„í•œë‹¤.", "ê´€ì°°ì´ ì–´ë µë‹¤."]}, {"name": "ê¸´ê¼¬ë¦¬ì œë¹„ë‚˜ë¹„", "key": "longtail_swallowtail", "id": "LE-005", "rarity": "UNCOMMON", "regions": ["GRASSLAND"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ê¼¬ë¦¬ê°€ ê¸¸ë‹¤.", "ë‚ ê°œê°€ í¬ë‹¤.", "í¬ê·€í•œ ë‚˜ë¹„ë‹¤."]}, {"name": "ë°•ê°ì‹œë‚˜ë¹„", "key": "hawk_moth", "id": "LE-006", "rarity": "UNCOMMON", "regions": ["PARK", "CITY"], "times": ["EVENING"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì •ì§€ ë¹„í–‰ì„ í•œë‹¤.", "ë²Œì²˜ëŸ¼ ë³´ì¸ë‹¤.", "ë‚ ê°¯ì§“ì´ ë¹ ë¥´ë‹¤."]}, {"name": "ê½ƒë§¤ë¯¸", "key": "spotted_lanternfly", "id": "LE-007", "rarity": "UNCOMMON", "regions": ["FOREST", "CITY"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["í™”ë ¤í•œ ë‚ ê°œë¥¼ ê°€ì¡Œë‹¤.", "ì™¸ë˜ í•´ì¶©ì´ë‹¤.", "ì§‘ë‹¨ìœ¼ë¡œ ë‚˜íƒ€ë‚œë‹¤."]}, {"name": "ë§ë§¤ë¯¸", "key": "large_cicada", "id": "CI-001", "rarity": "UNCOMMON", "regions": ["FOREST"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ëª¸ì§‘ì´ í¬ë‹¤.", "ì†Œë¦¬ê°€ ë§¤ìš° í¬ë‹¤.", "ì—¬ë¦„ì˜ ìƒì§•ì´ë‹¤."]}, {"name": "í„¸ë§¤ë¯¸", "key": "hairy_cicada", "id": "CI-002", "rarity": "RARE", "regions": ["MOUNTAIN", "FOREST"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ëª¸ì— í„¸ì´ ë§ë‹¤.", "ê°œì²´ ìˆ˜ê°€ ì ë‹¤.", "ì¡°ìš©í•œ í¸ì´ë‹¤."]}, {"name": "ì°¸ë§¤ë¯¸", "key": "true_cicada", "id": "CI-003", "rarity": "COMMON", "regions": ["CITY", "FOREST"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ê°€ì¥ í”í•œ ë§¤ë¯¸ë‹¤.", "ë§´ë§´ ì†Œë¦¬ë¥¼ ë‚¸ë‹¤.", "ìˆ˜ì»·ë§Œ ìš´ë‹¤."]}, {"name": "ê³ ì¶”ì ìë¦¬", "key": "scarlet_dragonfly", "id": "DR-001", "rarity": "COMMON", "regions": ["LAKE", "PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë¶‰ì€ ëª¸ìƒ‰ì´ íŠ¹ì§•ì´ë‹¤.", "ê°€ì„ì— ë§ë‹¤.", "ë„ì‹¬ ì ì‘ë ¥ì´ ë†’ë‹¤."]}, {"name": "ì¥ìˆ˜ì ìë¦¬", "key": "giant_dragonfly", "id": "DR-002", "rarity": "UNCOMMON", "regions": ["RIVER", "LAKE"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ëª¸ì§‘ì´ í¬ë‹¤.", "ë¹„í–‰ë ¥ì´ ë›°ì–´ë‚˜ë‹¤.", "í¬ì‹ì„±ì´ë‹¤."]}, {"name": "ì‹¤ì ìë¦¬", "key": "damselfly", "id": "DR-003", "rarity": "UNCOMMON", "regions": ["RIVER", "WETLAND"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ëª¸ì´ ê°€ëŠ˜ë‹¤.", "ë‚ ê°œë¥¼ ì ‘ê³  ì‰°ë‹¤.", "ê¹¨ë—í•œ ë¬¼ì— ì‚°ë‹¤."]}, {"name": "ë¬¼ì ìë¦¬", "key": "water_dragonfly", "id": "DR-004", "rarity": "UNCOMMON", "regions": ["RIVER"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë¬¼ê°€ë¥¼ ë‚ ì•„ë‹¤ë‹Œë‹¤.", "ë¯¼ì²©í•˜ë‹¤.", "í¬ì‹ìë‹¤."]}, {"name": "ëœì¥ì ìë¦¬", "key": "brown_dragonfly", "id": "DR-005", "rarity": "COMMON", "regions": ["LAKE", "PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ê°ˆìƒ‰ ëª¸ìƒ‰ì´ë‹¤.", "ê°€ì„ì— í”í•˜ë‹¤.", "ë„ì‹¬ì—ì„œë„ ë³´ì¸ë‹¤."]}, {"name": "ê¿€ë²Œ", "key": "honeybee", "id": "HY-001", "rarity": "COMMON", "regions": ["PARK", "FARM"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì‚¬íšŒì„± ê³¤ì¶©ì´ë‹¤.", "ì¶¤ìœ¼ë¡œ ì†Œí†µí•œë‹¤.", "ìˆ˜ë¶„ì— ì¤‘ìš”í•˜ë‹¤."]}, {"name": "ì¥ìˆ˜ë§ë²Œ", "key": "giant_hornet", "id": "HY-002", "rarity": "EPIC", "regions": ["MOUNTAIN", "FOREST"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ê³µê²©ì„±ì´ ê°•í•˜ë‹¤.", "ë…ì„±ì´ ë†’ë‹¤.", "ì ‘ê·¼ ì£¼ì˜."]}, {"name": "í˜¸ë°•ë²Œ", "key": "bumblebee", "id": "HY-003", "rarity": "UNCOMMON", "regions": ["GRASSLAND", "PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ëª¸ì´ ë‘¥ê¸€ë‹¤.", "í„¸ì´ ë§ë‹¤.", "ì˜¨ìˆœí•œ í¸ì´ë‹¤."]}, {"name": "íŒŒë¦¬", "key": "fly", "id": "FL-001", "rarity": "COMMON", "regions": ["CITY", "FARM"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY", "RAIN"], "desc": ["ë²ˆì‹ë ¥ì´ ê°•í•˜ë‹¤.", "ë¶„í•´ì ì—­í• ì„ í•œë‹¤.", "ìœ„ìƒ ë¬¸ì œë„ ìˆë‹¤."]}, {"name": "ëª¨ê¸°", "key": "mosquito", "id": "FL-002", "rarity": "COMMON", "regions": ["WETLAND", "RIVER"], "times": ["NIGHT"], "weathers": ["RAIN", "FOG"], "desc": ["ì•”ì»·ë§Œ í¡í˜ˆí•œë‹¤.", "ì§ˆë³‘ì„ ì˜®ê¸´ë‹¤.", "ì—¬ë¦„ë°¤ì— ë§ë‹¤."]}, {"name": "ê½ƒë“±ì—", "key": "hoverfly", "id": "FL-003", "rarity": "COMMON", "regions": ["PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë²Œì²˜ëŸ¼ ë³´ì¸ë‹¤.", "ì¹¨ì´ ì—†ë‹¤.", "ìµì¶©ì´ë‹¤."]}, {"name": "ê·€ëšœë¼ë¯¸", "key": "cricket", "id": "OR-001", "rarity": "COMMON", "regions": ["GRASSLAND", "PARK"], "times": ["NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë‚ ê°œë¥¼ ë¹„ë²¼ ìš´ë‹¤.", "ì•¼í–‰ì„±ì´ë‹¤.", "ì†Œë¦¬ê°€ í¬ë‹¤."]}, {"name": "ë°©ì•„ê¹¨ë¹„", "key": "katydid", "id": "OR-002", "rarity": "COMMON", "regions": ["GRASSLAND", "PARK"], "times": ["DAY", "NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ìì²˜ëŸ¼ ìœ„ì¥í•œë‹¤.", "ì í”„ë ¥ì´ ì¢‹ë‹¤.", "ìš¸ìŒì´ í¬ë‹¤."]}, {"name": "ë©”ëšœê¸°", "key": "grasshopper", "id": "OR-003", "rarity": "COMMON", "regions": ["GRASSLAND", "FARM"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë©€ë¦¬ ë›´ë‹¤.", "ì´ˆì‹ì„±ì´ë‹¤.", "ë“¤íŒì— ë§ë‹¤."]}, {"name": "ì—¬ì¹˜", "key": "katydid_large", "id": "OR-004", "rarity": "UNCOMMON", "regions": ["FOREST"], "times": ["NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë°©ì•„ê¹¨ë¹„ë³´ë‹¤ í¬ë‹¤.", "ì†Œë¦¬ê°€ í¬ë‹¤.", "ì•¼í–‰ì„±ì´ë‹¤."]}, {"name": "ì¢€ì‚¬ë§ˆê·€", "key": "small_mantis", "id": "MA-001", "rarity": "UNCOMMON", "regions": ["GRASSLAND", "PARK"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ì²´êµ¬ê°€ ì‘ë‹¤.", "í¬ì‹ìë‹¤.", "ìœ„ì¥ì´ ë›°ì–´ë‚˜ë‹¤."]}, {"name": "ë‚œì´ˆì‚¬ë§ˆê·€", "key": "orchid_mantis", "id": "MA-002", "rarity": "EPIC", "regions": ["PARK", "FOREST"], "times": ["DAY"], "weathers": ["SUNNY"], "desc": ["ê½ƒì²˜ëŸ¼ ìƒê²¼ë‹¤.", "ìœ„ì¥ ì‚¬ëƒ¥ì— íŠ¹í™”ëë‹¤.", "ë§¤ìš° í¬ê·€í•˜ë‹¤."]}, {"name": "ìì‚¬ê·€ë²Œë ˆ", "key": "leaf_insect", "id": "CA-001", "rarity": "EPIC", "regions": ["FOREST"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ìê³¼ êµ¬ë¶„ì´ ì–´ë µë‹¤.", "ì›€ì§ì„ì´ ëŠë¦¬ë‹¤.", "ìœ„ì¥ íŠ¹í™”ì¢…ì´ë‹¤."]}, {"name": "ëŒ€ë²Œë ˆ", "key": "stick_insect", "id": "CA-002", "rarity": "UNCOMMON", "regions": ["FOREST"], "times": ["NIGHT"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë‚˜ë­‡ê°€ì§€ì²˜ëŸ¼ ìƒê²¼ë‹¤.", "ì •ì§€ ì‹œ ë°œê²¬ì´ ì–´ë µë‹¤.", "ìœ„ì¥ì´ ë›°ì–´ë‚˜ë‹¤."]}, {"name": "ê³µë²Œë ˆ", "key": "pill_bug", "id": "OT-001", "rarity": "COMMON", "regions": ["FOREST", "CITY"], "times": ["NIGHT", "EVENING"], "weathers": ["RAIN", "FOG", "CLOUDY"], "desc": ["ëª¸ì„ ë‘¥ê¸€ê²Œ ë§Œë‹¤.", "ë¶„í•´ìë‹¤.", "ìŠµê¸°ë¥¼ ì¢‹ì•„í•œë‹¤."]}, {"name": "ì§€ë„¤", "key": "centipede", "id": "OT-002", "rarity": "UNCOMMON", "regions": ["FOREST", "MOUNTAIN"], "times": ["NIGHT"], "weathers": ["RAIN", "FOG"], "desc": ["ë‹¤ë¦¬ê°€ ë§ë‹¤.", "ë…ì„ ê°€ì§„ ì¢…ì´ ìˆë‹¤.", "í¬ì‹ì„±ì´ë‹¤."]}, {"name": "ëˆë²Œë ˆ", "key": "house_centipede", "id": "OT-003", "rarity": "COMMON", "regions": ["CITY"], "times": ["NIGHT"], "weathers": ["CLOUDY", "RAIN"], "desc": ["ì§‘ì•ˆì—ì„œ ë³´ì¸ë‹¤.", "ë¹ ë¥´ë‹¤.", "ìµì¶©ìœ¼ë¡œ ë¶„ë¥˜ëœë‹¤."]}, {"name": "í’ì´", "key": "beetle_grub", "id": "OT-004", "rarity": "COMMON", "regions": ["FOREST", "FARM"], "times": ["DAY", "EVENING"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë”±ì •ë²Œë ˆ ìœ ì¶©ì´ë‹¤.", "ë•…ì†ì— ì‚°ë‹¤.", "ì„±ì¶©ìœ¼ë¡œ ë³€íƒœí•œë‹¤."]}, {"name": "ë¬¼ì¥êµ°", "key": "giant_water_bug", "id": "AQ-002", "rarity": "RARE", "regions": ["LAKE", "WETLAND"], "times": ["NIGHT", "EVENING"], "weathers": ["CLOUDY", "RAIN"], "desc": ["ìˆ˜ì„œ ìµœìƒìœ„ í¬ì‹ìë‹¤.", "ì•ë‹¤ë¦¬ê°€ ê°•í•˜ë‹¤.", "ì‚¬ëƒ¥ë ¥ì´ ë›°ì–´ë‚˜ë‹¤."]}, {"name": "ì†Œê¸ˆìŸì´", "key": "water_strider", "id": "AQ-003", "rarity": "COMMON", "regions": ["RIVER", "LAKE"], "times": ["DAY"], "weathers": ["SUNNY", "CLOUDY"], "desc": ["ë¬¼ ìœ„ë¥¼ ê±·ëŠ”ë‹¤.", "ì¥ë ¥ì„ ì´ìš©í•œë‹¤.", "ë¯¼ì²©í•˜ë‹¤."]}, {"name": "ë•…ê°•ì•„ì§€", "key": "mole_cricket", "id": "OR-005", "rarity": "UNCOMMON", "regions": ["FARM", "GRASSLAND"], "times": ["NIGHT"], "weathers": ["CLOUDY", "RAIN"], "desc": ["ë•…ì„ íŒë‹¤.", "ìš¸ìŒì†Œë¦¬ê°€ íŠ¹ì§•ì´ë‹¤.", "ë†ì‘ë¬¼ì— í”¼í•´ë¥¼ ì¤€ë‹¤."]}, {"name": "ê²Ÿê°•êµ¬", "key": "isopod", "id": "OT-005", "rarity": "COMMON", "regions": ["WETLAND", "RIVER"], "times": ["NIGHT", "EVENING"], "weathers": ["RAIN", "FOG", "CLOUDY"], "desc": ["ê³µë²Œë ˆì™€ ìœ ì‚¬í•˜ë‹¤.", "ë¶„í•´ì ì—­í• ì„ í•œë‹¤.", "ìŠµí•œ í™˜ê²½ì„ ì„ í˜¸í•œë‹¤."]}];
const RARITY_POINTS = {COMMON:10, UNCOMMON:20, RARE:30, EPIC:40, LEGENDARY:50};
const SHOP = [
  { key:'kit', name:'ì±„ì§‘ì„¸íŠ¸', desc:'ì±„ì§‘ ì‹œë„ íšŸìˆ˜ +5', price:100 },
  { key:'bait', name:'ìœ ì¸ìš©ë¨¹ì´', desc:'ì¡°ìš° ì‹œ 1íšŒ ì„±ê³µë¥  50%', price:100 },
  { key:'spray', name:'ê¼¬ì´ë¯¸ ìŠ¤í”„ë ˆì´', desc:'í•„ë“œ ë„ë§ í™•ë¥  -20% (ë‹¤ìŒ 3íšŒ ì ‘ê·¼)', price:150 },
  { key:'flash', name:'í”Œë˜ì‹œ', desc:'ì•¼ê°„ ì±„ì§‘ ê°€ëŠ¥(1ì¼ 1íšŒ)', price:200 },
];

const DEFAULT_STATE = {
  playerName: 'ì€ì„±ì´',
  points: 0,
  title: 'ì´ˆë³´ íƒí—˜ê°€',
  titlesUnlocked: ['ì´ˆë³´ íƒí—˜ê°€'],
  selectedTitle: 'ì´ˆë³´ íƒí—˜ê°€',
  stats: {
    totalCaught: 0,
    totalTimeSec: 0,
    steps: 0,
    distanceM: 0,
  },
  caught: {}, // key -> count
  dexSeen: {}, // key -> true
  items: {
    kit: 10,
    bait: 2,
    spray: 1,
    flash: 1,
  },
  dailyMax: { kit: 10, bait: 2, spray: 1, flash: 1 },
  dailyLast: '',
  test: {
    randomStart: true,
    infiniteItems: false,
    useRealGPS: false,
    keyboard: true,
  },
  world: {
    x: 0, y: 0, // meters
  },
  runtime: {
    sprayCharges: 0,
    flashUsedDay: '',
  }
};

const $ = sel => document.querySelector(sel);
const app = {
  state: null,
  mode: 'title', // title|field|dex|bag|shop|settings|profile|encounter
  t0: performance.now(),
  lastTick: performance.now(),
  input: {
    dragging: false,
    lastX: 0, lastY: 0,
    vx: 0, vy: 0,
  },
  entities: [],
  entityId: 1,
  encounter: null,
  cooldownUntil: 0,
};

function todayStr() {
  const d = new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}

function loadState() {
  try {
    const raw = localStorage.getItem('captcha_bugs_state_v1');
    if (raw) return Object.assign(structuredClone(DEFAULT_STATE), JSON.parse(raw));
  } catch(e) {}
  return structuredClone(DEFAULT_STATE);
}

function saveState() {
  localStorage.setItem('captcha_bugs_state_v1', JSON.stringify(app.state));
}

function resetDailyIfNeeded() {
  const t = todayStr();
  if (app.state.dailyLast !== t) {
    app.state.dailyLast = t;
    // daily recovery (cap)
    for (const k of Object.keys(app.state.items)) {
      const max = app.state.dailyMax[k] ?? app.state.items[k];
      app.state.items[k] = Math.min(max, max);
    }
    app.state.runtime.flashUsedDay = '';
    app.state.runtime.sprayCharges = 0;
    saveState();
    toast('ì¼ì¼ ì•„ì´í…œì´ íšŒë³µëì–´');
  }
}

function rarityEmoji(r) {
  return ({COMMON:'ğŸ', UNCOMMON:'ğŸª²', RARE:'ğŸ¦‹', EPIC:'ğŸ•·ï¸', LEGENDARY:'ğŸ²'})[r] || 'ğŸ›';
}

function envFromPos(x,y) {
  // Simple biome based on sin/cos patterns (replaces real map; smooth transitions)
  const n1 = Math.sin(x/380) * 0.6 + Math.cos(y/420) * 0.4;
  const n2 = Math.sin((x+y)/520) * 0.5;
  const v = (n1 + n2);
  const water = Math.cos(x/700) * Math.sin(y/610);
  const city = Math.sin(x/900+2.2) * Math.cos(y/880+1.7);

  if (water > 0.55) return 'RIVER';
  if (water < -0.62) return 'LAKE';
  if (city > 0.62) return 'CITY';
  if (v > 0.40) return 'FOREST';
  if (v > 0.05) return 'PARK';
  return 'GRASSLAND';
}

function timeTag() {
  const h = new Date().getHours();
  if (h >= 5 && h < 10) return 'MORNING';
  if (h >= 10 && h < 17) return 'DAY';
  if (h >= 17 && h < 20) return 'EVENING';
  return 'NIGHT';
}

function weatherTag() {
  // deterministic daily pseudo-weather
  const t = todayStr().split('-').join('');
  let seed = 0;
  for (const ch of t) seed = (seed*31 + ch.charCodeAt(0))>>>0;
  const r = seed % 100;
  if (r < 45) return 'SUNNY';
  if (r < 75) return 'CLOUDY';
  if (r < 90) return 'RAIN';
  return 'FOG';
}

function pickInsectForEnv(env) {
  const t = timeTag();
  const w = weatherTag();
  const pool = INSECTS.filter(b => (b.regions||[]).includes(env) && (b.times||[]).includes(t) && (b.weathers||[]).includes(w));
  const fallback = INSECTS.filter(b => (b.regions||[]).includes(env));
  const use = pool.length ? pool : (fallback.length ? fallback : INSECTS);
  // rarity-weighted pick
  const weight = (r)=>({COMMON:55,UNCOMMON:28,RARE:12,EPIC:4,LEGENDARY:1}[r]||10);
  const total = use.reduce((s,b)=>s+weight(b.rarity),0);
  let roll = Math.random()*total;
  for (const b of use) {
    roll -= weight(b.rarity);
    if (roll<=0) return {...b, _t:t, _w:w, _env:env};
  }
  return {...use[0], _t:t, _w:w, _env:env};
}

function canInteract(entity) {
  const d = Math.hypot(entity.dx, entity.dy);
  return d <= entity.interactRadius;
}

function makeEntity(kind, data) {
  const id = app.entityId++;
  const e = {
    id,
    kind, // 'bug'|'treasure'
    data,
    // offset in meters relative to player
    dx: (Math.random()*2-1) * (10 + Math.random()*35),
    dy: (Math.random()*2-1) * (10 + Math.random()*35),
    createdAt: performance.now(),
    escaped: false,
    interactRadius: 12,
    node: null,
    hadApproachRoll: false,
  };
  return e;
}

function ensureEntities() {
  const now = performance.now();
  if (now < app.cooldownUntil) return;
  // keep 3 bugs + occasional treasure
  const bugs = app.entities.filter(e=>e.kind==='bug');
  const treasures = app.entities.filter(e=>e.kind==='treasure');
  const env = envFromPos(app.state.world.x, app.state.world.y);

  while (bugs.length < 3 && app.entities.filter(e=>e.kind==='bug').length < 3) {
    const b = pickInsectForEnv(env);
    app.state.dexSeen[b.key] = true;
    app.entities.push(makeEntity('bug', b));
  }
  if (treasures.length < 1 && Math.random() < 0.18) {
    app.entities.push(makeEntity('treasure', {name:'ë³´ë¬¼ìƒì', key:'treasure', rarity:'UNCOMMON', _env:env, _t:timeTag(), _w:weatherTag()}));
  }
}

function removeEntity(id) {
  const idx = app.entities.findIndex(e=>e.id===id);
  if (idx>=0) {
    const n = app.entities[idx].node;
    if (n && n.parentNode) n.parentNode.removeChild(n);
    app.entities.splice(idx,1);
  }
}

function titleFromStats() {
  // global titles by total caught
  const total = app.state.stats.totalCaught;
  const base = [
    {t:'ì´ˆë³´ íƒí—˜ê°€', n:0},
    {t:'íƒí—˜ê°€', n:20},
    {t:'ëŠ¥ìˆ™í•œ íƒí—˜ê°€', n:30},
    {t:'ë…¸ë ¨í•œ íƒí—˜ê°€', n:40},
  ];
  for (let i=base.length-1;i>=0;i--) {
    if (total >= base[i].n) {
      unlockTitle(base[i].t);
      return base[i].t;
    }
  }
  return 'ì´ˆë³´ íƒí—˜ê°€';
}

function unlockTitle(t) {
  if (!app.state.titlesUnlocked.includes(t)) app.state.titlesUnlocked.push(t);
}

function updateSpecificTitles() {
  for (const bug of INSECTS) {
    const c = app.state.caught[bug.key] || 0;
    if (c >= 20) unlockTitle(bug.name+' ìˆ™ë ¨ê°€');
    if (c >= 30) unlockTitle(bug.name+' ì „ë¬¸ê°€');
    if (c >= 50) unlockTitle(bug.name+' ë§¤ë‹ˆì•„');
  }
}

function refreshHUD() {
  $('#playerName').textContent = app.state.playerName;
  $('#playerTitle').textContent = app.state.selectedTitle || app.state.title;
  $('#pointsNum').textContent = String(app.state.points);
  $('#envPill').textContent = envFromPos(app.state.world.x, app.state.world.y);
}

function toast(msg) {
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display='none', 1400);
}

function showScreen(name) {
  $('#titleScreen').classList.toggle('active', name==='title');
  $('#fieldScreen').classList.toggle('active', name==='field');
  app.mode = name;
}

function openModal(type, payload={}) {
  const overlay = $('#overlay');
  const modal = $('#modal');
  overlay.classList.add('active');
  modal.innerHTML = '';
  if (type==='dex') buildDex(modal);
  if (type==='bag') buildBag(modal);
  if (type==='shop') buildShop(modal);
  if (type==='settings') buildSettings(modal);
  if (type==='profile') buildProfile(modal);
  modal.scrollTop = 0;
}

function closeModal() {
  $('#overlay').classList.remove('active');
  $('#modal').innerHTML = '';
}

$('#overlay').addEventListener('click', (e)=> {
  if (e.target.id==='overlay') closeModal();
});

function buildProfile(root) {
  root.innerHTML = `
    <h2>í”„ë¡œí•„</h2>
    <div class="row">
      <div class="kv"><div class="k">ì´ ì¡ì€ ë§ˆë¦¬ìˆ˜</div><div class="v">${app.state.stats.totalCaught}</div></div>
      <div class="kv"><div class="k">ë„ê°(íšë“ ì¹´ë“œ)</div><div class="v">${Object.keys(app.state.caught).length} / ?</div></div>
      <div class="kv"><div class="k">ë³´ìœ  í¬ì¸íŠ¸</div><div class="v">${app.state.points}</div></div>
      <div class="kv"><div class="k">ì´ íƒí—˜ ì‹œê°„</div><div class="v">${formatTime(app.state.stats.totalTimeSec)}</div></div>
      <div class="kv"><div class="k">ê±¸ìŒìˆ˜</div><div class="v">${app.state.stats.steps}</div></div>
      <div class="kv"><div class="k">ê±°ë¦¬</div><div class="v">${Math.round(app.state.stats.distanceM)} m</div></div>
    </div>
    <h2>ì¹­í˜¸ ì„¤ì •</h2>
    <div class="row" id="titleList"></div>
    <div class="actions">
      <button class="mbtn secondary" id="closeProfile">ë‹«ê¸°</button>
    </div>
  `;
  const list = root.querySelector('#titleList');
  for (const t of app.state.titlesUnlocked) {
    const b = document.createElement('button');
    b.className = 'mbtn ' + (t===app.state.selectedTitle ? 'primary' : 'secondary');
    b.textContent = t;
    b.style.margin = '4px';
    b.onclick = ()=> {
      app.state.selectedTitle = t;
      saveState();
      refreshHUD();
      openModal('profile');
    };
    list.appendChild(b);
  }
  root.querySelector('#closeProfile').onclick = closeModal;
}

function buildDex(root) {
  root.innerHTML = `
    <h2>ë„ê°</h2>
    <div id="dexGrid"></div>
    <div class="actions">
      <button class="mbtn secondary" id="closeDex">ë‹«ê¸°</button>
    </div>
  `;
  const grid = root.querySelector('#dexGrid');
  for (const b of INSECTS) {
    const c = app.state.caught[b.key] || 0;
    const seen = !!app.state.dexSeen[b.key];
    const icon = rarityEmoji(b.rarity);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="top">
        <div class="icon">${seen ? icon : 'â”'}</div>
        <div>
          <div class="t1">${seen ? b.name : '???'}</div>
          <div class="t2">${seen ? (b.key+' / '+b.id) : 'ë¯¸í™•ì¸'}</div>
        </div>
      </div>
      <div class="meta">
        <span class="badge r">${b.rarity}</span>
        <span class="badge">${(b.regions||[])[0]||'OT'}</span>
      </div>
      <div class="count">ì¡ì€ ë§ˆë¦¬ìˆ˜: <b>${c}</b></div>
    `;
    card.onclick = ()=> openDexCard(b);
    grid.appendChild(card);
  }
  root.querySelector('#closeDex').onclick = closeModal;
}

function openDexCard(b) {
  const c = app.state.caught[b.key] || 0;
  const seen = !!app.state.dexSeen[b.key];
  const icon = rarityEmoji(b.rarity);
  const overlay = $('#overlay');
  const modal = $('#modal');
  overlay.classList.add('active');
  modal.innerHTML = `
    <h2>ë„ê° ì¹´ë“œ</h2>
    <div style="display:flex;gap:12px;align-items:center;padding:6px;">
      <div style="width:92px;height:92px;border-radius:22px;background:rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;font-size:44px;">
        ${seen ? icon : 'â”'}
      </div>
      <div style="flex:1;">
        <div style="font-weight:1000;font-size:18px;color:#141826;">${seen ? b.name : '???'}</div>
        <div style="font-weight:900;color:rgba(20,24,38,.65);margin-top:2px;">${seen ? (b.key+' / '+b.id) : 'ë¯¸í™•ì¸'}</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <span class="badge r">${b.rarity}</span>
          <span class="badge">${(b.regions||[]).join(' / ')}</span>
        </div>
      </div>
    </div>
    <div style="margin:10px 6px;background:rgba(0,0,0,.06);border-radius:18px;padding:10px 12px;">
      <div style="font-size:11px;font-weight:1000;color:rgba(0,0,0,.55);">ì¡ì€ ë§ˆë¦¬ìˆ˜</div>
      <div style="font-weight:1000;font-size:18px;color:#141826;margin-top:4px;">${c}</div>
    </div>
    <div style="margin:10px 6px;background:rgba(0,0,0,.06);border-radius:18px;padding:10px 12px;">
      <div style="font-size:11px;font-weight:1000;color:rgba(0,0,0,.55);">ì„¤ëª…</div>
      <div style="margin-top:8px;font-weight:900;color:#141826;line-height:1.5;">
        <div>â€¢ ${b.desc?.[0]||''}</div>
        <div>â€¢ ${b.desc?.[1]||''}</div>
        <div>â€¢ ${b.desc?.[2]||''}</div>
      </div>
    </div>
    <div class="actions">
      <button class="mbtn secondary" id="closeCard">ë‹«ê¸°</button>
    </div>
  `;
  modal.querySelector('#closeCard').onclick = ()=> openModal('dex');
}

function buildBag(root) {
  const it = app.state.items;
  root.innerHTML = `
    <h2>ê°€ë°©</h2>
    <div class="row">
      <div class="kv"><div class="k">ì±„ì§‘ì„¸íŠ¸</div><div class="v">${it.kit}</div></div>
      <div class="kv"><div class="k">ìœ ì¸ìš©ë¨¹ì´</div><div class="v">${it.bait}</div></div>
      <div class="kv"><div class="k">ê¼¬ì´ë¯¸ ìŠ¤í”„ë ˆì´</div><div class="v">${it.spray}</div></div>
      <div class="kv"><div class="k">í”Œë˜ì‹œ</div><div class="v">${it.flash}</div></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button class="mbtn primary" id="openShop" style="flex:1;">ìƒì </button>
      <button class="mbtn secondary" id="closeBag" style="flex:1;">ë‹«ê¸°</button>
    </div>
    <div style="margin-top:10px;font-size:12px;font-weight:900;color:rgba(20,24,38,.7);">
      â€» ì•„ì´í…œì€ í•˜ë£¨ 1íšŒ ìë™ íšŒë³µ(ë¬´í•œ ëˆ„ì  ì•„ë‹˜)
    </div>
  `;
  root.querySelector('#openShop').onclick = ()=> openModal('shop');
  root.querySelector('#closeBag').onclick = closeModal;
}

function buildShop(root) {
  root.innerHTML = `
    <h2>ìƒì </h2>
    <div style="margin:6px;font-weight:1000;color:rgba(20,24,38,.75);">ë³´ìœ  í¬ì¸íŠ¸: <b>${app.state.points}</b></div>
    <div id="shopList" style="display:flex;flex-direction:column;gap:10px;padding:6px;"></div>
    <div class="actions">
      <button class="mbtn secondary" id="closeShop">ë‹«ê¸°</button>
    </div>
  `;
  const list = root.querySelector('#shopList');
  for (const s of SHOP) {
    const row = document.createElement('div');
    row.className = 'kv';
    row.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
        <div>
          <div style="font-weight:1000;">${s.name} <span style="font-size:11px;color:rgba(0,0,0,.55);font-weight:1000;">(${s.price}P)</span></div>
          <div style="font-size:12px;color:rgba(0,0,0,.62);font-weight:900;margin-top:4px;">${s.desc}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
          <div style="font-size:12px;font-weight:1000;color:rgba(0,0,0,.62);">ë³´ìœ : ${app.state.items[s.key]}</div>
          <button class="mbtn primary" data-buy="${s.key}">êµ¬ë§¤</button>
        </div>
      </div>
    `;
    row.querySelector('[data-buy]').onclick = ()=> buyItem(s.key);
    list.appendChild(row);
  }
  root.querySelector('#closeShop').onclick = closeModal;
}

function buyItem(key) {
  const s = SHOP.find(x=>x.key===key);
  if (!s) return;
  if (app.state.test.infiniteItems) {
    toast('í…ŒìŠ¤íŠ¸: ì•„ì´í…œ ë¬´í•œ');
    app.state.items[key] += (key==='kit' ? 5 : 1);
    saveState();
    openModal('shop');
    return;
  }
  if (app.state.points < s.price) {
    toast('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´');
    return;
  }
  app.state.points -= s.price;
  app.state.items[key] += (key==='kit' ? 5 : 1);
  saveState();
  refreshHUD();
  openModal('shop');
}

function buildSettings(root) {
  const t = app.state.test;
  root.innerHTML = `
    <h2>ì„¤ì •</h2>
    <div class="kv">
      <div class="k">í”Œë ˆì´ì–´ ì´ë¦„</div>
      <input id="nameInput" value="${app.state.playerName}" style="width:100%;margin-top:8px;padding:12px 12px;border-radius:14px;border:1px solid rgba(0,0,0,.12);font-weight:900;font-size:14px;"/>
      <div style="margin-top:8px;font-size:12px;font-weight:900;color:rgba(0,0,0,.62);">ì¢Œìƒë‹¨ í‘œì‹œ/í”„ë¡œí•„ì— ì ìš©</div>
    </div>

    <h2>í…ŒìŠ¤íŠ¸ ì˜µì…˜</h2>
    <div class="kv">
      <label style="display:flex;align-items:center;gap:10px;font-weight:1000;">
        <input type="checkbox" id="randomStart" ${t.randomStart?'checked':''}/>
        ì‹œì‘ ì‹œ ìœ„ì¹˜ ëœë¤ ë°”ë€œ
      </label>
      <label style="display:flex;align-items:center;gap:10px;font-weight:1000;margin-top:10px;">
        <input type="checkbox" id="infiniteItems" ${t.infiniteItems?'checked':''}/>
        ì•„ì´í…œ ë¬´í•œ(í…ŒìŠ¤íŠ¸)
      </label>
      <label style="display:flex;align-items:center;gap:10px;font-weight:1000;margin-top:10px;">
        <input type="checkbox" id="useRealGPS" ${t.useRealGPS?'checked':''}/>
        ì‹¤ì œ GPS ì‚¬ìš©(ì‹¤í—˜)
      </label>
      <label style="display:flex;align-items:center;gap:10px;font-weight:1000;margin-top:10px;">
        <input type="checkbox" id="keyboard" ${t.keyboard?'checked':''}/>
        í‚¤ë³´ë“œ ì…ë ¥(ë°©í–¥í‚¤/Enter/ESC)
      </label>
      <div style="margin-top:10px;font-size:12px;font-weight:900;color:rgba(0,0,0,.62);">
        â€» GPS ONì¸ë° ê¶Œí•œ/ì§€ì›ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ê°€ìƒ ì´ë™ìœ¼ë¡œ ëŒ€ì²´
      </div>
    </div>

    <div class="actions">
      <button class="mbtn secondary" id="resetSave">ì„¸ì´ë¸Œ ì´ˆê¸°í™”</button>
      <button class="mbtn primary" id="applySettings">ì ìš©</button>
      <button class="mbtn secondary" id="closeSettings">ë‹«ê¸°</button>
    </div>
  `;
  root.querySelector('#closeSettings').onclick = closeModal;
  root.querySelector('#applySettings').onclick = ()=> {
    const name = root.querySelector('#nameInput').value.trim() || 'ì€ì„±ì´';
    app.state.playerName = name;
    app.state.test.randomStart = root.querySelector('#randomStart').checked;
    app.state.test.infiniteItems = root.querySelector('#infiniteItems').checked;
    app.state.test.useRealGPS = root.querySelector('#useRealGPS').checked;
    app.state.test.keyboard = root.querySelector('#keyboard').checked;
    saveState();
    refreshHUD();
    toast('ì„¤ì • ì ìš©');
    if (app.state.test.useRealGPS) startGPS();
    closeModal();
  };
  root.querySelector('#resetSave').onclick = ()=> {
    if (!confirm('ì„¸ì´ë¸Œë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    localStorage.removeItem('captcha_bugs_state_v1');
    location.reload();
  };
}

function formatTime(sec) {
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if (h>0) return `${h}h ${m}m`;
  if (m>0) return `${m}m ${s}s`;
  return `${s}s`;
}

function openEncounter(entity) {
  if (app.mode !== 'field') return;
  app.encounter = { entityId: entity.id, data: entity.data, baitUsed: false };
  $('#encBugEmoji').textContent = rarityEmoji(entity.data.rarity);
  $('#encBugName').textContent = entity.data.name;
  $('#encBugId').textContent = entity.data.id;
  $('#encRarity').textContent = entity.data.rarity;
  $('#encRegion').textContent = entity.data._env || envFromPos(app.state.world.x, app.state.world.y);
  $('#encTime').textContent = entity.data._t || timeTag();
  $('#encWeather').textContent = entity.data._w || weatherTag();
  $('#resultLine').textContent = '';
  $('#resultLine').className = '';
  $('#useBaitBtn').textContent = `ë¨¹ì´ ì‚¬ìš©(+ì„±ê³µ) (ë³´ìœ :${app.state.items.bait})`;
  $('#encounterOverlay').classList.add('active');
  app.mode = 'encounter';
}

function closeEncounter() {
  $('#encounterOverlay').classList.remove('active');
  app.mode = 'field';
  app.encounter = null;
  $('#netAnim').classList.remove('swing');
  $('#resultLine').textContent = '';
}

function consumeItem(key, n=1) {
  if (app.state.test.infiniteItems) return true;
  if ((app.state.items[key]||0) < n) return false;
  app.state.items[key] -= n;
  return true;
}

function catchAttempt() {
  if (!app.encounter) return;
  const ent = app.entities.find(e=>e.id===app.encounter.entityId);
  if (!ent) { closeEncounter(); return; }
  // require kit
  if (!app.state.test.infiniteItems && (app.state.items.kit||0) <= 0) {
    toast('ì±„ì§‘ì„¸íŠ¸ê°€ ë¶€ì¡±í•´');
    return;
  }

  // swing
  const net = $('#netAnim');
  net.classList.remove('swing');
  void net.offsetWidth;
  net.classList.add('swing');

  // consume kit
  if (!app.state.test.infiniteItems) app.state.items.kit = Math.max(0, app.state.items.kit - 1);

  // success chance
  let p = 0.30;
  if (app.encounter.baitUsed) p = 0.50;
  // flash gate for NIGHT (simple: if night and no flash used => -)
  if (timeTag()==='NIGHT') {
    const usedDay = app.state.runtime.flashUsedDay || '';
    if (usedDay !== todayStr()) {
      // need flash to enable
      if (consumeItem('flash',1)) {
        app.state.runtime.flashUsedDay = todayStr();
        toast('í”Œë˜ì‹œ ì‚¬ìš©: ì•¼ê°„ ì±„ì§‘ ê°€ëŠ¥');
      } else {
        p = 0.10; // very hard without flash
      }
    }
  }

  const ok = Math.random() < p;
  const line = $('#resultLine');
  if (ok) {
    const pts = RARITY_POINTS[ent.data.rarity] || 10;
    app.state.points += pts;
    app.state.stats.totalCaught += 1;
    app.state.caught[ent.data.key] = (app.state.caught[ent.data.key]||0) + 1;
    updateSpecificTitles();
    app.state.title = titleFromStats();
    // unlock base title automatically; selected stays
    if (!app.state.selectedTitle) app.state.selectedTitle = app.state.title;
    saveState();
    refreshHUD();
    line.textContent = `ì¡ì•˜ë‹¤!! +${pts}P`;
    line.className = 'ok';
    toast('ë„ê°ì— ê¸°ë¡ë¨');
    removeEntity(ent.id);
    // cooldown for next spawn (short)
    app.cooldownUntil = performance.now() + 900;
  } else {
    line.textContent = 'ì‹¤íŒ¨~';
    line.className = 'no';
    // bug escapes; remove entity and cooldown
    removeEntity(ent.id);
    app.cooldownUntil = performance.now() + 1400;
  }
  saveState();
}

function useBait() {
  if (!app.encounter) return;
  if (app.encounter.baitUsed) { toast('ì´ë¯¸ ì‚¬ìš©í•¨'); return; }
  if (!consumeItem('bait',1)) { toast('ë¨¹ì´ê°€ ë¶€ì¡±í•´'); return; }
  app.encounter.baitUsed = true;
  $('#useBaitBtn').textContent = 'ë¨¹ì´ ì‚¬ìš©ë¨(ì„±ê³µë¥  50%)';
  saveState();
}

$('#catchBtn').addEventListener('click', catchAttempt);
$('#useBaitBtn').addEventListener('click', useBait);
$('#closeEncBtn').addEventListener('click', ()=> {
  closeEncounter();
});

function tick(now) {
  const dt = Math.min(0.05, (now - app.lastTick)/1000);
  app.lastTick = now;
  if (app.mode === 'field') {
    // time accumulation
    app.state.stats.totalTimeSec += dt;
    // inertia decay
    app.input.vx *= 0.82;
    app.input.vy *= 0.82;
    // apply velocity
    const speed = 18; // m/s scaled for feel
    const mx = app.input.vx * speed * dt;
    const my = app.input.vy * speed * dt;
    if (!app.state.test.useRealGPS) {
      if (Math.abs(mx)+Math.abs(my) > 0.001) {
        moveWorld(mx, my);
      }
    }
    // render
    ensureEntities();
    renderWorld(now);
    renderEntities();
  }
  requestAnimationFrame(tick);
}

function moveWorld(dx, dy) {
  // dx,dy: meters (world coords)
  app.state.world.x += dx;
  app.state.world.y += dy;
  const dist = Math.hypot(dx,dy);
  if (dist > 0) {
    app.state.stats.distanceM += dist;
    app.state.stats.steps += Math.max(0, Math.round(dist/0.8)); // 0.8m per step
  }
  saveState();
}

function renderWorld(now) {
  const x = app.state.world.x;
  const y = app.state.world.y;
  // parallax (sky slow, mid slower, fore fastest)
  const skyX = -x*0.06, skyY = -y*0.04;
  const midX = -x*0.16, midY = -y*0.12;
  const foreX = -x*0.28, foreY = -y*0.22;

  // subtle camera shake while moving
  const moving = Math.hypot(app.input.vx, app.input.vy) > 0.02;
  const shake = moving ? (Math.sin(now/110)*0.7 + Math.cos(now/170)*0.5) : 0;
  const s2 = moving ? (Math.sin(now/90)*0.6) : 0;

  $('#layerSky').style.transform = `translate(${skyX+shake}px, ${skyY}px)`;
  $('#layerMid').style.transform = `translate(${midX+shake*1.5}px, ${midY+s2}px)`;
  $('#layerFore').style.transform = `translate(${foreX+shake*2.4}px, ${foreY+s2*1.3}px)`;

  // slight zoom in encounter mode
  if (app.mode === 'encounter') {
    $('#world').style.transform = 'perspective(900px) rotateX(30deg) scale(1.10)';
  } else {
    $('#world').style.transform = 'perspective(900px) rotateX(30deg) scale(1.05)';
  }

  // env pill
  $('#envPill').textContent = envFromPos(x,y);
}

function renderEntities() {
  const wrap = $('#entities');
  const moving = Math.hypot(app.input.vx, app.input.vy) > 0.02;
  const sprayActive = app.state.runtime.sprayCharges > 0;

  for (const e of app.entities) {
    if (!e.node) {
      const n = document.createElement('div');
      n.className = 'entity ' + (e.kind==='bug' ? 'bug' : 'treasure');
      const sprite = document.createElement('div');
      sprite.className = 'sprite';
      const emoji = e.kind==='treasure' ? 'ğŸ§°' : rarityEmoji(e.data.rarity);
      sprite.textContent = emoji;
      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = e.kind==='treasure' ? 'ë³´ë¬¼ìƒì' : e.data.name;
      const hint = document.createElement('div');
      hint.className = 'hint';
      hint.style.display = 'none';
      hint.textContent = 'ê°€ê¹Œì´ ê°€ì•¼ í•¨';
      n.appendChild(hint);
      n.appendChild(sprite);
      n.appendChild(label);
      n.onclick = ()=> onEntityTap(e.id);
      wrap.appendChild(n);
      e.node = n;
    }

    // update relative position (screen)
    // map meters to screen pixels (zoomed-in feel)
    const scalePx = 7.2; // px per meter
    const px = e.dx * scalePx;
    const py = e.dy * scalePx;

    // distance-based scale & blur/sat
    const d = Math.hypot(e.dx, e.dy);
    const D = 42; // view distance
    const p = 1.6;
    const sc = clamp(0.45, 1.35, 1.20 - Math.pow(d/D, p));
    const blur = clamp(0, 1.2, (d/D) * 1.2);
    const sat = clamp(0.7, 1.0, 1.05 - (d/D)*0.35);
    const shadow = clamp(0.18, 0.65, 0.68 - (d/D)*0.5);

    e.node.style.transform = `translate(calc(50% + ${px}px), calc(50% + ${py}px)) translate(-50%,-50%) scale(${sc})`;
    e.node.style.filter = `blur(${blur}px) saturate(${sat}) drop-shadow(0 12px 14px rgba(0,0,0,${shadow}))`;

    // interaction lock if far
    const hint = e.node.querySelector('.hint');
    if (!canInteract(e)) {
      e.node.classList.add('locked');
      hint.style.display = 'block';
    } else {
      e.node.classList.remove('locked');
      hint.style.display = 'none';
      // approach roll for bugs (escape chance 50%, reduced by spray)
      if (e.kind==='bug' && !e.hadApproachRoll) {
        e.hadApproachRoll = true;
        let escapeChance = 0.50;
        if (sprayActive) escapeChance = Math.max(0.0, escapeChance - 0.20);
        if (Math.random() < escapeChance) {
          // escapes
          removeEntity(e.id);
          if (sprayActive) app.state.runtime.sprayCharges = Math.max(0, app.state.runtime.sprayCharges - 1);
          saveState();
          toast('ê³¤ì¶©ì´ ë„ë§ì³¤ë‹¤â€¦');
          app.cooldownUntil = performance.now() + 900;
          continue;
        } else {
          if (sprayActive) app.state.runtime.sprayCharges = Math.max(0, app.state.runtime.sprayCharges - 1);
          saveState();
        }
      }
    }
  }
}

function onEntityTap(id) {
  const e = app.entities.find(x=>x.id===id);
  if (!e) return;
  if (!canInteract(e)) {
    toast('ë” ê°€ê¹Œì´ ê°€ì•¼ í•´');
    return;
  }
  if (e.kind==='treasure') {
    // reward points
    const pts = 20;
    app.state.points += pts;
    saveState();
    refreshHUD();
    toast(`ë³´ë¬¼ìƒì! +${pts}P`);
    removeEntity(e.id);
    app.cooldownUntil = performance.now() + 800;
    return;
  }
  // bug -> encounter
  openEncounter(e);
}

function clamp(a,b,v) { return Math.max(a, Math.min(b,v)); }

// Movement input: drag to move camera (player stays)
function bindInput() {
  const view = $('#view');
  view.addEventListener('pointerdown', (e)=> {
    if (app.mode !== 'field') return;
    app.input.dragging = true;
    app.input.lastX = e.clientX;
    app.input.lastY = e.clientY;
    view.setPointerCapture(e.pointerId);
  });
  view.addEventListener('pointermove', (e)=> {
    if (!app.input.dragging || app.mode !== 'field') return;
    const dx = e.clientX - app.input.lastX;
    const dy = e.clientY - app.input.lastY;
    app.input.lastX = e.clientX;
    app.input.lastY = e.clientY;
    // convert screen drag to velocity (inverse: drag right -> move right)
    const s = 0.010;
    app.input.vx = clamp(-1,1, dx*s);
    app.input.vy = clamp(-1,1, dy*s);
  });
  view.addEventListener('pointerup', ()=> {
    app.input.dragging = false;
  });
  view.addEventListener('pointercancel', ()=> {
    app.input.dragging = false;
  });
  // prevent context menu
  view.addEventListener('contextmenu', (e)=> e.preventDefault());
}

function bindKeyboard() {
  const keys = new Set();
  window.addEventListener('keydown', (e)=> {
    if (!app.state?.test?.keyboard) return;
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Enter',' ','Escape'].includes(e.key)) e.preventDefault();
    keys.add(e.key);
    if (app.mode==='encounter') {
      if (e.key==='Enter' || e.key===' ') catchAttempt();
      if (e.key==='Escape') closeEncounter();
      return;
    }
    if (app.mode!=='field') {
      if (e.key==='Escape') closeModal();
      return;
    }
    if (e.key==='Enter' || e.key===' ') {
      // interact with nearest entity in radius
      const cand = app.entities.filter(canInteract).sort((a,b)=>Math.hypot(a.dx,a.dy)-Math.hypot(b.dx,b.dy))[0];
      if (cand) onEntityTap(cand.id);
    }
  });
  window.addEventListener('keyup', (e)=> {
    keys.delete(e.key);
  });
  // update key movement
  setInterval(()=> {
    if (!app.state?.test?.keyboard) return;
    if (app.mode!=='field') return;
    if (app.state.test.useRealGPS) return;
    let vx=0, vy=0;
    if (keys.has('ArrowLeft')) vx -= 1;
    if (keys.has('ArrowRight')) vx += 1;
    if (keys.has('ArrowUp')) vy -= 1;
    if (keys.has('ArrowDown')) vy += 1;
    const len = Math.hypot(vx,vy);
    if (len>0) { vx/=len; vy/=len; }
    // smooth
    app.input.vx = vx*0.55 + app.input.vx*0.45;
    app.input.vy = vy*0.55 + app.input.vy*0.45;
  }, 50);
}

let gpsWatchId = null;
function startGPS() {
  if (!app.state.test.useRealGPS) return;
  if (!navigator.geolocation) {
    toast('GPS ë¯¸ì§€ì›: ê°€ìƒ ì´ë™ìœ¼ë¡œ');
    app.state.test.useRealGPS = false;
    saveState();
    return;
  }
  if (gpsWatchId != null) return;
  let last = null;
  gpsWatchId = navigator.geolocation.watchPosition((pos)=> {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    // map lat/lon deltas to meters (rough)
    if (!last) {
      last = {lat,lon};
      return;
    }
    const dLat = (lat - last.lat) * 111000;
    const dLon = (lon - last.lon) * 88000;
    last = {lat,lon};
    moveWorld(dLon, -dLat);
  }, (err)=> {
    toast('GPS ê¶Œí•œ/ì˜¤ë¥˜: ê°€ìƒ ì´ë™ìœ¼ë¡œ');
    app.state.test.useRealGPS = false;
    gpsWatchId = null;
    saveState();
  }, {
    enableHighAccuracy: true,
    maximumAge: 1000,
    timeout: 8000
  });
}

function stopGPS() {
  if (gpsWatchId != null) {
    navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId = null;
  }
}

function applyStartPosition() {
  if (app.state.test.randomStart) {
    // daily seed
    const t = todayStr().split('-').join('');
    let seed = 0; for (const ch of t) seed = (seed*131 + ch.charCodeAt(0))>>>0;
    const rand = (n)=> {
      seed = (seed*1664525 + 1013904223)>>>0;
      return (seed/4294967296) * n;
    };
    app.state.world.x = Math.round((rand(1)-0.5)*5000); // +-2500m
    app.state.world.y = Math.round((rand(1)-0.5)*5000);
  } else {
    app.state.world.x = app.state.world.x || 0;
    app.state.world.y = app.state.world.y || 0;
  }
  saveState();
}

function useSprayFromBag() {
  if (!consumeItem('spray',1)) {
    toast('ê¼¬ì´ë¯¸ ìŠ¤í”„ë ˆì´ê°€ ë¶€ì¡±í•´');
    return;
  }
  app.state.runtime.sprayCharges = 3;
  saveState();
  toast('ê¼¬ì´ë¯¸ ìŠ¤í”„ë ˆì´: ë‹¤ìŒ 3íšŒ ì ‘ê·¼ ë„ë§ë¥  ê°ì†Œ');
}

function init() {
  app.state = loadState();
  resetDailyIfNeeded();
  applyStartPosition();
  app.state.title = titleFromStats();
  if (!app.state.selectedTitle) app.state.selectedTitle = app.state.title;
  updateSpecificTitles();
  saveState();
  refreshHUD();

  // UI binds
  $('#startBtn').onclick = ()=> {
    showScreen('field');
    app.mode = 'field';
    ensureEntities();
    toast('íƒí—˜ ì‹œì‘!');
  };
  $('#quickDexBtn').onclick = ()=> {
    showScreen('field');
    openModal('dex');
    app.mode = 'field';
  };
  $('#dexBtn').onclick = ()=> openModal('dex');
  $('#bagBtn').onclick = ()=> openModal('bag');
  $('#settingsBtn').onclick = ()=> openModal('settings');
  $('#playerBadge').onclick = ()=> openModal('profile');

  bindInput();
  bindKeyboard();

  // quick use spray: long press on bag button (simple)
  let pressTm = null;
  $('#bagBtn').addEventListener('pointerdown', ()=> {
    pressTm = setTimeout(()=> {
      useSprayFromBag();
    }, 520);
  });
  $('#bagBtn').addEventListener('pointerup', ()=> {
    if (pressTm) clearTimeout(pressTm);
    pressTm = null;
  });

  if (app.state.test.useRealGPS) startGPS();

  requestAnimationFrame(tick);
}

init();
</script>
</body>
</html>
